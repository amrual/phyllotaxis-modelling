var ze=Object.defineProperty;var Ge=(t,e,i)=>e in t?ze(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var h=(t,e,i)=>Ge(t,typeof e!="symbol"?e+"":e,i);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function i(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=i(s);fetch(s.href,a)}})();var M="INUMBER",W="IOP1",Q="IOP2",Z="IOP3",T="IVAR",V="IVARNAME",G="IFUNCALL",oe="IFUNDEF",A="IEXPR",ve="IEXPREVAL",$="IMEMBER",le="IENDSTATEMENT",Y="IARRAY";function v(t,e){this.type=t,this.value=e??0}v.prototype.toString=function(){switch(this.type){case M:case W:case Q:case Z:case T:case V:case le:return this.value;case G:return"CALL "+this.value;case oe:return"DEF "+this.value;case Y:return"ARRAY "+this.value;case $:return"."+this.value;default:return"Invalid Instruction"}};function ue(t){return new v(W,t)}function O(t){return new v(Q,t)}function Le(t){return new v(Z,t)}function fe(t,e,i,n,s){for(var a=[],r=[],o,l,p,c,d=0;d<t.length;d++){var u=t[d],f=u.type;if(f===M||f===V)Array.isArray(u.value)?a.push.apply(a,fe(u.value.map(function(b){return new v(M,b)}).concat(new v(Y,u.value.length)),e,i,n,s)):a.push(u);else if(f===T&&s.hasOwnProperty(u.value))u=new v(M,s[u.value]),a.push(u);else if(f===Q&&a.length>1)l=a.pop(),o=a.pop(),c=i[u.value],u=new v(M,c(o.value,l.value)),a.push(u);else if(f===Z&&a.length>2)p=a.pop(),l=a.pop(),o=a.pop(),u.value==="?"?a.push(o.value?l.value:p.value):(c=n[u.value],u=new v(M,c(o.value,l.value,p.value)),a.push(u));else if(f===W&&a.length>0)o=a.pop(),c=e[u.value],u=new v(M,c(o.value)),a.push(u);else if(f===A){for(;a.length>0;)r.push(a.shift());r.push(new v(A,fe(u.value,e,i,n,s)))}else if(f===$&&a.length>0)o=a.pop(),a.push(new v(M,o.value[u.value]));else{for(;a.length>0;)r.push(a.shift());r.push(u)}}for(;a.length>0;)r.push(a.shift());return r}function De(t,e,i){for(var n=[],s=0;s<t.length;s++){var a=t[s],r=a.type;if(r===T&&a.value===e)for(var o=0;o<i.tokens.length;o++){var l=i.tokens[o],p;l.type===W?p=ue(l.value):l.type===Q?p=O(l.value):l.type===Z?p=Le(l.value):p=new v(l.type,l.value),n.push(p)}else r===A?n.push(new v(A,De(a.value,e,i))):n.push(a)}return n}function D(t,e,i){var n=[],s,a,r,o,l,p;if(me(t))return I(t,i);for(var c=t.length,d=0;d<c;d++){var u=t[d],f=u.type;if(f===M||f===V)n.push(u.value);else if(f===Q)a=n.pop(),s=n.pop(),u.value==="and"?n.push(s?!!D(a,e,i):!1):u.value==="or"?n.push(s?!0:!!D(a,e,i)):u.value==="="?(o=e.binaryOps[u.value],n.push(o(s,D(a,e,i),i))):(o=e.binaryOps[u.value],n.push(o(I(s,i),I(a,i))));else if(f===Z)r=n.pop(),a=n.pop(),s=n.pop(),u.value==="?"?n.push(D(s?a:r,e,i)):(o=e.ternaryOps[u.value],n.push(o(I(s,i),I(a,i),I(r,i))));else if(f===T)if(u.value in e.functions)n.push(e.functions[u.value]);else if(u.value in e.unaryOps&&e.parser.isOperatorEnabled(u.value))n.push(e.unaryOps[u.value]);else{var b=i[u.value];if(b!==void 0)n.push(b);else throw new Error("undefined variable: "+u.value)}else if(f===W)s=n.pop(),o=e.unaryOps[u.value],n.push(o(I(s,i)));else if(f===G){for(p=u.value,l=[];p-- >0;)l.unshift(I(n.pop(),i));if(o=n.pop(),o.apply&&o.call)n.push(o.apply(void 0,l));else throw new Error(o+" is not a function")}else if(f===oe)n.push(function(){for(var x=n.pop(),P=[],k=u.value;k-- >0;)P.unshift(n.pop());var E=n.pop(),F=function(){for(var re=Object.assign({},i),N=0,j=P.length;N<j;N++)re[P[N]]=arguments[N];return D(x,e,re)};return Object.defineProperty(F,"name",{value:E,writable:!1}),i[E]=F,F}());else if(f===A)n.push(Ye(u,e));else if(f===ve)n.push(u);else if(f===$)s=n.pop(),n.push(s[u.value]);else if(f===le)n.pop();else if(f===Y){for(p=u.value,l=[];p-- >0;)l.unshift(n.pop());n.push(l)}else throw new Error("invalid Expression")}if(n.length>1)throw new Error("invalid Expression (parity)");return n[0]===0?0:I(n[0],i)}function Ye(t,e,i){return me(t)?t:{type:ve,value:function(n){return D(t.value,e,n)}}}function me(t){return t&&t.type===ve}function I(t,e){return me(t)?t.value(e):t}function ge(t,e){for(var i=[],n,s,a,r,o,l,p=0;p<t.length;p++){var c=t[p],d=c.type;if(d===M)typeof c.value=="number"&&c.value<0?i.push("("+c.value+")"):Array.isArray(c.value)?i.push("["+c.value.map(Me).join(", ")+"]"):i.push(Me(c.value));else if(d===Q)s=i.pop(),n=i.pop(),r=c.value,e?r==="^"?i.push("Math.pow("+n+", "+s+")"):r==="and"?i.push("(!!"+n+" && !!"+s+")"):r==="or"?i.push("(!!"+n+" || !!"+s+")"):r==="||"?i.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+n+"),("+s+")))"):r==="=="?i.push("("+n+" === "+s+")"):r==="!="?i.push("("+n+" !== "+s+")"):r==="["?i.push(n+"[("+s+") | 0]"):i.push("("+n+" "+r+" "+s+")"):r==="["?i.push(n+"["+s+"]"):i.push("("+n+" "+r+" "+s+")");else if(d===Z)if(a=i.pop(),s=i.pop(),n=i.pop(),r=c.value,r==="?")i.push("("+n+" ? "+s+" : "+a+")");else throw new Error("invalid Expression");else if(d===T||d===V)i.push(c.value);else if(d===W)n=i.pop(),r=c.value,r==="-"||r==="+"?i.push("("+r+n+")"):e?r==="not"?i.push("(!"+n+")"):r==="!"?i.push("fac("+n+")"):i.push(r+"("+n+")"):r==="!"?i.push("("+n+"!)"):i.push("("+r+" "+n+")");else if(d===G){for(l=c.value,o=[];l-- >0;)o.unshift(i.pop());r=i.pop(),i.push(r+"("+o.join(", ")+")")}else if(d===oe){for(s=i.pop(),l=c.value,o=[];l-- >0;)o.unshift(i.pop());n=i.pop(),e?i.push("("+n+" = function("+o.join(", ")+") { return "+s+" })"):i.push("("+n+"("+o.join(", ")+") = "+s+")")}else if(d===$)n=i.pop(),i.push(n+"."+c.value);else if(d===Y){for(l=c.value,o=[];l-- >0;)o.unshift(i.pop());i.push("["+o.join(", ")+"]")}else if(d===A)i.push("("+ge(c.value,e)+")");else if(d!==le)throw new Error("invalid Expression")}return i.length>1&&(e?i=[i.join(",")]:i=[i.join(";")]),String(i[0])}function Me(t){return typeof t=="string"?JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):t}function H(t,e){for(var i=0;i<t.length;i++)if(t[i]===e)return!0;return!1}function be(t,e,i){i=i||{};for(var n=!!i.withMembers,s=null,a=0;a<t.length;a++){var r=t[a];r.type===T||r.type===V?!n&&!H(e,r.value)?e.push(r.value):(s!==null&&(H(e,s)||e.push(s)),s=r.value):r.type===$&&n&&s!==null?s+="."+r.value:r.type===A?be(r.value,e,i):s!==null&&(H(e,s)||e.push(s),s=null)}s!==null&&!H(e,s)&&e.push(s)}function S(t,e){this.tokens=t,this.parser=e,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.functions=e.functions}S.prototype.simplify=function(t){return t=t||{},new S(fe(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,t),this.parser)};S.prototype.substitute=function(t,e){return e instanceof S||(e=this.parser.parse(String(e))),new S(De(this.tokens,t,e),this.parser)};S.prototype.evaluate=function(t){return t=t||{},D(this.tokens,this,t)};S.prototype.toString=function(){return ge(this.tokens,!1)};S.prototype.symbols=function(t){t=t||{};var e=[];return be(this.tokens,e,t),e};S.prototype.variables=function(t){t=t||{};var e=[];be(this.tokens,e,t);var i=this.functions;return e.filter(function(n){return!(n in i)})};S.prototype.toJSFunction=function(t,e){var i=this,n=new Function(t,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+ge(this.simplify(e).tokens,!0)+"; }");return function(){return n.apply(i,arguments)}};var se="TEOF",m="TOP",he="TNUMBER",Ue="TSTRING",R="TPAREN",X="TBRACKET",pe="TCOMMA",ye="TNAME",we="TSEMICOLON";function Ve(t,e,i){this.type=t,this.value=e,this.index=i}Ve.prototype.toString=function(){return this.type+": "+this.value};function y(t,e){this.pos=0,this.current=null,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.consts=t.consts,this.expression=e,this.savedPosition=0,this.savedCurrent=null,this.options=t.options,this.parser=t}y.prototype.newToken=function(t,e,i){return new Ve(t,e,i??this.pos)};y.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};y.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};y.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(se,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};y.prototype.isString=function(){var t=!1,e=this.pos,i=this.expression.charAt(e);if(i==="'"||i==='"')for(var n=this.expression.indexOf(i,e+1);n>=0&&this.pos<this.expression.length;){if(this.pos=n+1,this.expression.charAt(n-1)!=="\\"){var s=this.expression.substring(e+1,n);this.current=this.newToken(Ue,this.unescape(s),e),t=!0;break}n=this.expression.indexOf(i,n+1)}return t};y.prototype.isParen=function(){var t=this.expression.charAt(this.pos);return t==="("||t===")"?(this.current=this.newToken(R,t),this.pos++,!0):!1};y.prototype.isBracket=function(){var t=this.expression.charAt(this.pos);return(t==="["||t==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(X,t),this.pos++,!0):!1};y.prototype.isComma=function(){var t=this.expression.charAt(this.pos);return t===","?(this.current=this.newToken(pe,","),this.pos++,!0):!1};y.prototype.isSemicolon=function(){var t=this.expression.charAt(this.pos);return t===";"?(this.current=this.newToken(we,";"),this.pos++,!0):!1};y.prototype.isConst=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var i=this.expression.charAt(e);if(i.toUpperCase()===i.toLowerCase()&&(e===this.pos||i!=="_"&&i!=="."&&(i<"0"||i>"9")))break}if(e>t){var n=this.expression.substring(t,e);if(n in this.consts)return this.current=this.newToken(he,this.consts[n]),this.pos+=n.length,!0}return!1};y.prototype.isNamedOp=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var i=this.expression.charAt(e);if(i.toUpperCase()===i.toLowerCase()&&(e===this.pos||i!=="_"&&(i<"0"||i>"9")))break}if(e>t){var n=this.expression.substring(t,e);if(this.isOperatorEnabled(n)&&(n in this.binaryOps||n in this.unaryOps||n in this.ternaryOps))return this.current=this.newToken(m,n),this.pos+=n.length,!0}return!1};y.prototype.isName=function(){for(var t=this.pos,e=t,i=!1;e<this.expression.length;e++){var n=this.expression.charAt(e);if(n.toUpperCase()===n.toLowerCase()){if(e===this.pos&&(n==="$"||n==="_")){n==="_"&&(i=!0);continue}else if(e===this.pos||!i||n!=="_"&&(n<"0"||n>"9"))break}else i=!0}if(i){var s=this.expression.substring(t,e);return this.current=this.newToken(ye,s),this.pos+=s.length,!0}return!1};y.prototype.isWhitespace=function(){for(var t=!1,e=this.expression.charAt(this.pos);(e===" "||e==="	"||e===`
`||e==="\r")&&(t=!0,this.pos++,!(this.pos>=this.expression.length));)e=this.expression.charAt(this.pos);return t};var Xe=/^[0-9a-f]{4}$/i;y.prototype.unescape=function(t){var e=t.indexOf("\\");if(e<0)return t;for(var i=t.substring(0,e);e>=0;){var n=t.charAt(++e);switch(n){case"'":i+="'";break;case'"':i+='"';break;case"\\":i+="\\";break;case"/":i+="/";break;case"b":i+="\b";break;case"f":i+="\f";break;case"n":i+=`
`;break;case"r":i+="\r";break;case"t":i+="	";break;case"u":var s=t.substring(e+1,e+5);Xe.test(s)||this.parseError("Illegal escape sequence: \\u"+s),i+=String.fromCharCode(parseInt(s,16)),e+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+n+'"')}++e;var a=t.indexOf("\\",e);i+=t.substring(e,a<0?t.length:a),e=a}return i};y.prototype.isComment=function(){var t=this.expression.charAt(this.pos);return t==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};y.prototype.isRadixInteger=function(){var t=this.pos;if(t>=this.expression.length-2||this.expression.charAt(t)!=="0")return!1;++t;var e,i;if(this.expression.charAt(t)==="x")e=16,i=/^[0-9a-f]$/i,++t;else if(this.expression.charAt(t)==="b")e=2,i=/^[01]$/i,++t;else return!1;for(var n=!1,s=t;t<this.expression.length;){var a=this.expression.charAt(t);if(i.test(a))t++,n=!0;else break}return n&&(this.current=this.newToken(he,parseInt(this.expression.substring(s,t),e)),this.pos=t),n};y.prototype.isNumber=function(){for(var t=!1,e=this.pos,i=e,n=e,s=!1,a=!1,r;e<this.expression.length&&(r=this.expression.charAt(e),r>="0"&&r<="9"||!s&&r===".");)r==="."?s=!0:a=!0,e++,t=a;if(t&&(n=e),r==="e"||r==="E"){e++;for(var o=!0,l=!1;e<this.expression.length;){if(r=this.expression.charAt(e),o&&(r==="+"||r==="-"))o=!1;else if(r>="0"&&r<="9")l=!0,o=!1;else break;e++}l||(e=n)}return t?(this.current=this.newToken(he,parseFloat(this.expression.substring(i,e))),this.pos=e):this.pos=n,t};y.prototype.isOperator=function(){var t=this.pos,e=this.expression.charAt(this.pos);if(e==="+"||e==="-"||e==="*"||e==="/"||e==="%"||e==="^"||e==="?"||e===":"||e===".")this.current=this.newToken(m,e);else if(e==="∙"||e==="•")this.current=this.newToken(m,"*");else if(e===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(m,">="),this.pos++):this.current=this.newToken(m,">");else if(e==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(m,"<="),this.pos++):this.current=this.newToken(m,"<");else if(e==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(m,"||"),this.pos++;else return!1;else if(e==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(m,"=="),this.pos++):this.current=this.newToken(m,e);else if(e==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(m,"!="),this.pos++):this.current=this.newToken(m,e);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=t,!1)};y.prototype.isOperatorEnabled=function(t){return this.parser.isOperatorEnabled(t)};y.prototype.getCoordinates=function(){var t=0,e,i=-1;do t++,e=this.pos-i,i=this.expression.indexOf(`
`,i+1);while(i>=0&&i<this.pos);return{line:t,column:e}};y.prototype.parseError=function(t){var e=this.getCoordinates();throw new Error("parse error ["+e.line+":"+e.column+"]: "+t)};function g(t,e,i){this.parser=t,this.tokens=e,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=i.allowMemberAccess!==!1}g.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};g.prototype.tokenMatches=function(t,e){return typeof e>"u"?!0:Array.isArray(e)?H(e,t.value):typeof e=="function"?e(t):t.value===e};g.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};g.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};g.prototype.accept=function(t,e){return this.nextToken.type===t&&this.tokenMatches(this.nextToken,e)?(this.next(),!0):!1};g.prototype.expect=function(t,e){if(!this.accept(t,e)){var i=this.tokens.getCoordinates();throw new Error("parse error ["+i.line+":"+i.column+"]: Expected "+(e||t))}};g.prototype.parseAtom=function(t){var e=this.tokens.unaryOps;function i(s){return s.value in e}if(this.accept(ye)||this.accept(m,i))t.push(new v(T,this.current.value));else if(this.accept(he))t.push(new v(M,this.current.value));else if(this.accept(Ue))t.push(new v(M,this.current.value));else if(this.accept(R,"("))this.parseExpression(t),this.expect(R,")");else if(this.accept(X,"["))if(this.accept(X,"]"))t.push(new v(Y,0));else{var n=this.parseArrayList(t);t.push(new v(Y,n))}else throw new Error("unexpected "+this.nextToken)};g.prototype.parseExpression=function(t){var e=[];this.parseUntilEndStatement(t,e)||(this.parseVariableAssignmentExpression(e),!this.parseUntilEndStatement(t,e)&&this.pushExpression(t,e))};g.prototype.pushExpression=function(t,e){for(var i=0,n=e.length;i<n;i++)t.push(e[i])};g.prototype.parseUntilEndStatement=function(t,e){return this.accept(we)?(this.nextToken&&this.nextToken.type!==se&&!(this.nextToken.type===R&&this.nextToken.value===")")&&e.push(new v(le)),this.nextToken.type!==se&&this.parseExpression(e),t.push(new v(A,e)),!0):!1};g.prototype.parseArrayList=function(t){for(var e=0;!this.accept(X,"]");)for(this.parseExpression(t),++e;this.accept(pe);)this.parseExpression(t),++e;return e};g.prototype.parseVariableAssignmentExpression=function(t){for(this.parseConditionalExpression(t);this.accept(m,"=");){var e=t.pop(),i=[],n=t.length-1;if(e.type===G){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var s=0,a=e.value+1;s<a;s++){var r=n-s;t[r].type===T&&(t[r]=new v(V,t[r].value))}this.parseVariableAssignmentExpression(i),t.push(new v(A,i)),t.push(new v(oe,e.value));continue}if(e.type!==T&&e.type!==$)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(i),t.push(new v(V,e.value)),t.push(new v(A,i)),t.push(O("="))}};g.prototype.parseConditionalExpression=function(t){for(this.parseOrExpression(t);this.accept(m,"?");){var e=[],i=[];this.parseConditionalExpression(e),this.expect(m,":"),this.parseConditionalExpression(i),t.push(new v(A,e)),t.push(new v(A,i)),t.push(Le("?"))}};g.prototype.parseOrExpression=function(t){for(this.parseAndExpression(t);this.accept(m,"or");){var e=[];this.parseAndExpression(e),t.push(new v(A,e)),t.push(O("or"))}};g.prototype.parseAndExpression=function(t){for(this.parseComparison(t);this.accept(m,"and");){var e=[];this.parseComparison(e),t.push(new v(A,e)),t.push(O("and"))}};var Je=["==","!=","<","<=",">=",">","in"];g.prototype.parseComparison=function(t){for(this.parseAddSub(t);this.accept(m,Je);){var e=this.current;this.parseAddSub(t),t.push(O(e.value))}};var We=["+","-","||"];g.prototype.parseAddSub=function(t){for(this.parseTerm(t);this.accept(m,We);){var e=this.current;this.parseTerm(t),t.push(O(e.value))}};var Qe=["*","/","%"];g.prototype.parseTerm=function(t){for(this.parseFactor(t);this.accept(m,Qe);){var e=this.current;this.parseFactor(t),t.push(O(e.value))}};g.prototype.parseFactor=function(t){var e=this.tokens.unaryOps;function i(s){return s.value in e}if(this.save(),this.accept(m,i)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===R&&this.nextToken.value==="("){this.restore(),this.parseExponential(t);return}else if(this.nextToken.type===we||this.nextToken.type===pe||this.nextToken.type===se||this.nextToken.type===R&&this.nextToken.value===")"){this.restore(),this.parseAtom(t);return}}var n=this.current;this.parseFactor(t),t.push(ue(n.value))}else this.parseExponential(t)};g.prototype.parseExponential=function(t){for(this.parsePostfixExpression(t);this.accept(m,"^");)this.parseFactor(t),t.push(O("^"))};g.prototype.parsePostfixExpression=function(t){for(this.parseFunctionCall(t);this.accept(m,"!");)t.push(ue("!"))};g.prototype.parseFunctionCall=function(t){var e=this.tokens.unaryOps;function i(a){return a.value in e}if(this.accept(m,i)){var n=this.current;this.parseAtom(t),t.push(ue(n.value))}else for(this.parseMemberExpression(t);this.accept(R,"(");)if(this.accept(R,")"))t.push(new v(G,0));else{var s=this.parseArgumentList(t);t.push(new v(G,s))}};g.prototype.parseArgumentList=function(t){for(var e=0;!this.accept(R,")");)for(this.parseExpression(t),++e;this.accept(pe);)this.parseExpression(t),++e;return e};g.prototype.parseMemberExpression=function(t){for(this.parseAtom(t);this.accept(m,".")||this.accept(X,"[");){var e=this.current;if(e.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(ye),t.push(new v($,this.current.value))}else if(e.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(t),this.expect(X,"]"),t.push(O("["))}else throw new Error("unexpected symbol: "+e.value)}};function Ze(t,e){return Number(t)+Number(e)}function et(t,e){return t-e}function tt(t,e){return t*e}function it(t,e){return t/e}function nt(t,e){return t%e}function st(t,e){return Array.isArray(t)&&Array.isArray(e)?t.concat(e):""+t+e}function rt(t,e){return t===e}function at(t,e){return t!==e}function ot(t,e){return t>e}function lt(t,e){return t<e}function ut(t,e){return t>=e}function ht(t,e){return t<=e}function pt(t,e){return!!(t&&e)}function ct(t,e){return!!(t||e)}function dt(t,e){return H(e,t)}function ft(t){return(Math.exp(t)-Math.exp(-t))/2}function vt(t){return(Math.exp(t)+Math.exp(-t))/2}function mt(t){return t===1/0?1:t===-1/0?-1:(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t))}function gt(t){return t===-1/0?t:Math.log(t+Math.sqrt(t*t+1))}function bt(t){return Math.log(t+Math.sqrt(t*t-1))}function yt(t){return Math.log((1+t)/(1-t))/2}function Pe(t){return Math.log(t)*Math.LOG10E}function wt(t){return-t}function xt(t){return!t}function Et(t){return t<0?Math.ceil(t):Math.floor(t)}function At(t){return Math.random()*(t||1)}function Se(t){return xe(t+1)}function kt(t){return isFinite(t)&&t===Math.round(t)}var Mt=4.7421875,ce=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function xe(t){var e,i;if(kt(t)){if(t<=0)return isFinite(t)?1/0:NaN;if(t>171)return 1/0;for(var n=t-2,s=t-1;n>1;)s*=n,n--;return s===0&&(s=1),s}if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*xe(1-t));if(t>=171.35)return 1/0;if(t>85){var a=t*t,r=a*t,o=r*t,l=o*t;return Math.sqrt(2*Math.PI/t)*Math.pow(t/Math.E,t)*(1+1/(12*t)+1/(288*a)-139/(51840*r)-571/(2488320*o)+163879/(209018880*l)+5246819/(75246796800*l*t))}--t,i=ce[0];for(var p=1;p<ce.length;++p)i+=ce[p]/(t+p);return e=t+Mt+.5,Math.sqrt(2*Math.PI)*Math.pow(e,t+.5)*Math.exp(-e)*i}function Pt(t){return Array.isArray(t)?t.length:String(t).length}function Ce(){for(var t=0,e=0,i=0;i<arguments.length;i++){var n=Math.abs(arguments[i]),s;e<n?(s=e/n,t=t*s*s+1,e=n):n>0?(s=n/e,t+=s*s):t+=n}return e===1/0?1/0:e*Math.sqrt(t)}function Ie(t,e,i){return t?e:i}function St(t,e){return typeof e>"u"||+e==0?Math.round(t):(t=+t,e=-+e,isNaN(t)||!(typeof e=="number"&&e%1===0)?NaN:(t=t.toString().split("e"),t=Math.round(+(t[0]+"e"+(t[1]?+t[1]-e:-e))),t=t.toString().split("e"),+(t[0]+"e"+(t[1]?+t[1]+e:e))))}function Ct(t,e,i){return i&&(i[t]=e),e}function It(t,e){return t[e|0]}function Tt(t){return arguments.length===1&&Array.isArray(t)?Math.max.apply(Math,t):Math.max.apply(Math,arguments)}function Rt(t){return arguments.length===1&&Array.isArray(t)?Math.min.apply(Math,t):Math.min.apply(Math,arguments)}function Ot(t,e){if(typeof t!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(e))throw new Error("Second argument to map is not an array");return e.map(function(i,n){return t(i,n)})}function Ft(t,e,i){if(typeof t!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(i))throw new Error("Second argument to fold is not an array");return i.reduce(function(n,s,a){return t(n,s,a)},e)}function Bt(t,e){if(typeof t!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(e))throw new Error("Second argument to filter is not an array");return e.filter(function(i,n){return t(i,n)})}function Kt(t,e){if(!(Array.isArray(e)||typeof e=="string"))throw new Error("Second argument to indexOf is not a string or array");return e.indexOf(t)}function Nt(t,e){if(!Array.isArray(e))throw new Error("Second argument to join is not an array");return e.join(t)}function Lt(t){return(t>0)-(t<0)||+t}var Te=1/3;function Dt(t){return t<0?-Math.pow(-t,Te):Math.pow(t,Te)}function Ut(t){return Math.exp(t)-1}function Vt(t){return Math.log(1+t)}function qt(t){return Math.log(t)/Math.LN2}function _(t){this.options=t||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||ft,cosh:Math.cosh||vt,tanh:Math.tanh||mt,asinh:Math.asinh||gt,acosh:Math.acosh||bt,atanh:Math.atanh||yt,sqrt:Math.sqrt,cbrt:Math.cbrt||Dt,log:Math.log,log2:Math.log2||qt,ln:Math.log,lg:Math.log10||Pe,log10:Math.log10||Pe,expm1:Math.expm1||Ut,log1p:Math.log1p||Vt,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||Et,"-":wt,"+":Number,exp:Math.exp,not:xt,length:Pt,"!":Se,sign:Math.sign||Lt},this.binaryOps={"+":Ze,"-":et,"*":tt,"/":it,"%":nt,"^":Math.pow,"||":st,"==":rt,"!=":at,">":ot,"<":lt,">=":ut,"<=":ht,and:pt,or:ct,in:dt,"=":Ct,"[":It},this.ternaryOps={"?":Ie},this.functions={random:At,fac:Se,min:Rt,max:Tt,hypot:Math.hypot||Ce,pyt:Math.hypot||Ce,pow:Math.pow,atan2:Math.atan2,if:Ie,gamma:xe,roundTo:St,map:Ot,fold:Ft,filter:Bt,indexOf:Kt,join:Nt},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}_.prototype.parse=function(t){var e=[],i=new g(this,new y(this,t),{allowMemberAccess:this.options.allowMemberAccess});return i.parseExpression(e),i.expect(se,"EOF"),new S(e,this)};_.prototype.evaluate=function(t,e){return this.parse(t).evaluate(e)};var qe=new _;_.parse=function(t){return qe.parse(t)};_.evaluate=function(t,e){return qe.parse(t).evaluate(e)};var Re={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function $t(t){return Re.hasOwnProperty(t)?Re[t]:t}_.prototype.isOperatorEnabled=function(t){var e=$t(t),i=this.options.operators||{};return!(e in i)||!!i[e]};const Oe=1e30,Fe=1e30,$e=new _;function _t(t){switch(t.type){case"exp":{const{A:e,lambda:i}=t;return{fn:n=>e*Math.exp(-n/i),hasHardCore:!1,d0:0}}case"gaussian":{const{A:e,sigma:i}=t,n=2*i*i;return{fn:s=>e*Math.exp(-(s*s)/n),hasHardCore:!1,d0:0}}case"softPower":{const{A:e,p:i,eps:n}=t;return{fn:s=>e/(Math.pow(s,i)+n),hasHardCore:!1,d0:0}}case"hardCoreExp":{const{A:e,lambda:i,d0:n}=t;return{fn:s=>e*Math.exp(-s/i),hasHardCore:!0,d0:n}}case"custom":{const e=$e.parse(t.expr),i={...t.params,d:0};return{fn:n=>{try{i.d=n;const s=e.evaluate(i);return Number.isFinite(s)?s:Fe}catch{return Fe}},hasHardCore:!1,d0:0}}}}function _e(t){try{return $e.parse(t),null}catch(e){return e instanceof Error?e.message:String(e)}}function Be(t){return()=>{let e=t+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}class jt{constructor(e){h(this,"rng");h(this,"spare",null);this.rng=Be(e)}next(){if(this.spare!==null){const a=this.spare;return this.spare=null,a}const e=Math.max(this.rng(),1e-12),i=this.rng(),n=Math.sqrt(-2*Math.log(e)),s=2*Math.PI*i;return this.spare=n*Math.sin(s),n*Math.cos(s)}reset(e){this.rng=Be(e),this.spare=null}}function Ht(t){const e=2*Math.PI;return t=t%e,t<0&&(t+=e),t}class zt{constructor(){h(this,"cfg");h(this,"primordia",[]);h(this,"kernel");h(this,"candidateCos");h(this,"candidateSin");h(this,"activeXs");h(this,"activeYs");h(this,"activeCount",0);h(this,"firstActiveIndex",0);h(this,"warnedOverflow",!1);h(this,"gaussianRng",new jt(12345))}init(e){this.cfg=e,this.kernel=_t(e.kernel),this.candidateCos=new Float64Array(e.angleSamples),this.candidateSin=new Float64Array(e.angleSamples);const i=2*Math.PI/e.angleSamples;for(let n=0;n<e.angleSamples;n++){const s=n*i;this.candidateCos[n]=Math.cos(s),this.candidateSin[n]=Math.sin(s)}this.activeXs=new Float64Array(e.totalPrimordia),this.activeYs=new Float64Array(e.totalPrimordia),this.gaussianRng.reset(e.noise.seed)}reset(){this.primordia=[],this.firstActiveIndex=0,this.warnedOverflow=!1,this.activeCount=0,this.gaussianRng.reset(this.cfg.noise.seed),this.addPrimordium(0)}step(){if(this.primordia.length>=this.cfg.totalPrimordia)return;this.driftAllPrimordia(),this.advanceFirstActiveIndex(),this.buildActiveArrays();let e=this.findMinimumFieldAngle();if(this.cfg.noise.enabled){const i=this.gaussianRng.next()*(this.cfg.noise.sigmaThetaDeg*Math.PI/180);e=Ht(e+i)}this.addPrimordium(e)}runBatch(){const e=Math.min(this.primordia.length+this.cfg.batchSize,this.cfg.totalPrimordia);let i=0;for(;this.primordia.length<e;)this.step(),i++;return i}isComplete(){return this.primordia.length>=this.cfg.totalPrimordia}driftAllPrimordia(){const e=this.cfg.v*this.cfg.dt;for(const i of this.primordia)i.r+=e}advanceFirstActiveIndex(){for(;this.firstActiveIndex<this.primordia.length&&this.primordia[this.firstActiveIndex].r>this.cfg.maxR;)this.firstActiveIndex++}buildActiveArrays(){this.activeCount=0;for(let e=this.firstActiveIndex;e<this.primordia.length;e++){if(this.activeCount>=this.activeXs.length){this.warnedOverflow||(console.warn("buildActiveArrays: active array overflow, truncating."),this.warnedOverflow=!0);break}const i=this.primordia[e];this.activeXs[this.activeCount]=i.r*i.ct,this.activeYs[this.activeCount]=i.r*i.st,this.activeCount++}}findMinimumFieldAngle(){const{R:e,angleSamples:i}=this.cfg,{fn:n,hasHardCore:s,d0:a}=this.kernel,r=E=>{const F=e*this.candidateCos[E],re=e*this.candidateSin[E];let N=0;for(let j=0;j<this.activeCount;j++){const Ee=F-this.activeXs[j],Ae=re-this.activeYs[j],ke=Math.sqrt(Ee*Ee+Ae*Ae);if(s&&ke<a)return Oe;N+=n(ke)}return N};let o=1/0,l=0;for(let E=0;E<i;E++){const F=r(E);F<o&&(o=F,l=E)}const p=l===0?i-1:l-1,c=l===i-1?0:l+1,d=r(p),u=o,f=r(c),b=2*(d-2*u+f);let x=l;if(Math.abs(b)>1e-12){const E=(d-f)/b;x=l+Math.max(-.5,Math.min(.5,E))}const P=2*Math.PI/i;let k=x*P;return k<0&&(k+=2*Math.PI),k>=2*Math.PI&&(k-=2*Math.PI),k}addPrimordium(e){this.primordia.push({r:this.cfg.R,theta:e,ct:Math.cos(e),st:Math.sin(e)})}getFieldValues(){const{R:e,angleSamples:i}=this.cfg,{fn:n,hasHardCore:s,d0:a}=this.kernel,r=new Float64Array(i);for(let o=0;o<i;o++){const l=e*this.candidateCos[o],p=e*this.candidateSin[o];let c=0;for(let d=0;d<this.activeCount;d++){const u=l-this.activeXs[d],f=p-this.activeYs[d],b=Math.sqrt(u*u+f*f);if(s&&b<a){c=Oe;break}c+=n(b)}r[o]=c}return r}computeDivergenceMetrics(e=200){const i=Math.max(1,this.primordia.length-e),n=[];for(let o=i;o<this.primordia.length;o++){let l=this.primordia[o].theta-this.primordia[o-1].theta;l=(l%(2*Math.PI)+2*Math.PI)%(2*Math.PI),n.push(l*180/Math.PI)}if(n.length===0)return{mean:0,stdDev:0,count:0};const s=n.reduce((o,l)=>o+l,0)/n.length,a=n.reduce((o,l)=>o+(l-s)**2,0)/n.length,r=Math.sqrt(a);return{mean:s,stdDev:r,count:n.length}}}function L(){return{R:1,v:.02,dt:1,maxR:3,angleSamples:720,totalPrimordia:1e3,batchSize:30,kernel:{type:"exp",A:1,lambda:.18},noise:{enabled:!0,sigmaThetaDeg:.1,seed:12345},render:{showRing:!0,showMetrics:!0,showFieldPlot:!1,pointRadius:5,scaleByDistance:!0}}}const ae=[{name:"Fibonacci (default)",description:"Classic MVP behavior with exponential kernel",config:L()},{name:"Tight inhibition",description:"Denser packing with smaller lambda",config:{...L(),totalPrimordia:800,kernel:{type:"exp",A:1,lambda:.12}}},{name:"Loose inhibition",description:"Sparser pattern with larger lambda",config:{...L(),kernel:{type:"exp",A:1,lambda:.28}}},{name:"Gaussian kernel",description:"Smoother falloff using Gaussian",config:{...L(),kernel:{type:"gaussian",A:1,sigma:.15}}},{name:"Hard-core",description:"Exclusion zone around primordia",config:{...L(),kernel:{type:"hardCoreExp",A:1,lambda:.18,d0:.05}}},{name:"Stress test (10000)",description:"Performance test with many primordia - may cause slowdown",config:{...L(),totalPrimordia:1e4,batchSize:100},isStressTest:!0}];function te(t){return JSON.parse(JSON.stringify(t))}function de(t){const e=[],i=[];t.R<=0&&e.push("R must be > 0"),t.angleSamples<36&&e.push("angleSamples must be >= 36"),t.totalPrimordia<2&&e.push("totalPrimordia must be >= 2"),t.batchSize<1&&e.push("batchSize must be >= 1"),t.maxR<=t.R&&e.push("maxR must be > R"),t.v<=0&&e.push("v must be > 0"),t.dt<=0&&e.push("dt must be > 0");const n=t.kernel;switch(n.type){case"exp":n.lambda<=0&&e.push("lambda must be > 0"),isFinite(n.A)||e.push("A must be finite");break;case"gaussian":n.sigma<=0&&e.push("sigma must be > 0"),isFinite(n.A)||e.push("A must be finite");break;case"softPower":n.p<=0&&e.push("p must be > 0"),n.eps<0&&e.push("eps must be >= 0"),isFinite(n.A)||e.push("A must be finite");break;case"hardCoreExp":n.lambda<=0&&e.push("lambda must be > 0"),n.d0<0&&e.push("d0 must be >= 0"),isFinite(n.A)||e.push("A must be finite"),n.d0>=t.R&&i.push(`d0 (${n.d0}) >= R (${t.R}): may invalidate many/all candidate angles`);break;case"custom":{const s=_e(n.expr);s&&e.push(`Invalid expression: ${s}`),n.params.lambda<=0&&e.push("lambda must be > 0"),n.params.sigma<=0&&e.push("sigma must be > 0"),n.params.p<=0&&e.push("p must be > 0"),n.params.eps<0&&e.push("eps must be >= 0"),n.params.d0<0&&e.push("d0 must be >= 0");break}}return t.noise.enabled&&t.noise.sigmaThetaDeg<0&&e.push("noise sigma must be >= 0"),t.render.pointRadius<=0&&e.push("pointRadius must be > 0"),{valid:e.length===0,errors:e,warnings:i}}function Gt(t){const e=JSON.stringify(t);return btoa(encodeURIComponent(e))}function Yt(t){try{const e=decodeURIComponent(atob(t));return JSON.parse(e)}catch{return null}}class Xt{constructor(e){h(this,"callbacks");h(this,"currentConfig");h(this,"sidebar");h(this,"validationDiv");h(this,"runBtn");h(this,"pauseBtn");h(this,"stepBtn");h(this,"resetBtn");h(this,"applyBtn");h(this,"presetSelect");h(this,"inputR");h(this,"inputV");h(this,"inputDt");h(this,"inputMaxR");h(this,"inputAngleSamples");h(this,"inputTotalPrimordia");h(this,"inputBatchSize");h(this,"kernelTypeSelect");h(this,"kernelParamsDiv");h(this,"inputKernelA");h(this,"inputKernelLambda");h(this,"inputKernelSigma");h(this,"inputKernelP");h(this,"inputKernelEps");h(this,"inputKernelD0");h(this,"customExprTextarea");h(this,"customExprValidation");h(this,"noiseEnabledCheckbox");h(this,"inputNoiseSigma");h(this,"inputNoiseSeed");h(this,"showRingCheckbox");h(this,"showMetricsCheckbox");h(this,"showFieldPlotCheckbox");h(this,"inputPointRadius");h(this,"scaleByDistanceCheckbox");h(this,"updateFieldPlotBtn");h(this,"fieldPlotCanvas");h(this,"fieldPlotCtx");this.callbacks=e,this.currentConfig=L()}init(){this.createSidebar(),this.bindEvents();const e=window.location.hash.slice(1);if(e){const i=Yt(e);if(i&&de(i).valid)return this.currentConfig=i,this.populateUIFromConfig(i),i}return this.populateUIFromConfig(this.currentConfig),te(this.currentConfig)}createSidebar(){this.sidebar=document.getElementById("sidebar"),this.sidebar.innerHTML=`
      <div class="ui-section">
        <div class="ui-row buttons">
          <button id="btn-run" class="btn primary">Run</button>
          <button id="btn-pause" class="btn">Pause</button>
          <button id="btn-step" class="btn">Step</button>
          <button id="btn-reset" class="btn">Reset</button>
        </div>
        <button id="btn-apply" class="btn apply-btn">Apply</button>
      </div>

      <div class="ui-section">
        <label class="ui-label">Preset</label>
        <select id="preset-select" class="ui-select"></select>
      </div>

      <div class="ui-section">
        <div class="ui-section-title">Simulation</div>
        <div class="ui-row">
          <label>R</label>
          <input type="number" id="input-R" step="0.1" min="0.1">
        </div>
        <div class="ui-row">
          <label>v</label>
          <input type="number" id="input-v" step="0.001" min="0.001">
        </div>
        <div class="ui-row">
          <label>dt</label>
          <input type="number" id="input-dt" step="0.1" min="0.1">
        </div>
        <div class="ui-row">
          <label>maxR</label>
          <input type="number" id="input-maxR" step="0.1" min="0.1">
        </div>
        <div class="ui-row">
          <label>angleSamples</label>
          <input type="number" id="input-angleSamples" step="1" min="36">
        </div>
        <div class="ui-row">
          <label>totalPrimordia</label>
          <input type="number" id="input-totalPrimordia" step="100" min="2">
        </div>
        <div class="ui-row">
          <label>batchSize</label>
          <input type="number" id="input-batchSize" step="1" min="1">
        </div>
      </div>

      <div class="ui-section">
        <div class="ui-section-title">Kernel</div>
        <div class="ui-row">
          <label>Type</label>
          <select id="kernel-type-select" class="ui-select">
            <option value="exp">Exponential</option>
            <option value="gaussian">Gaussian</option>
            <option value="softPower">Soft Power</option>
            <option value="hardCoreExp">Hard-Core Exp</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div id="kernel-params"></div>
      </div>

      <div class="ui-section">
        <div class="ui-section-title">Noise</div>
        <div class="ui-row checkbox-row">
          <input type="checkbox" id="noise-enabled">
          <label for="noise-enabled">Enable noise</label>
        </div>
        <div class="ui-row">
          <label>σ (deg)</label>
          <input type="number" id="input-noise-sigma" step="0.5" min="0">
        </div>
        <div class="ui-row">
          <label>Seed</label>
          <input type="number" id="input-noise-seed" step="1">
        </div>
      </div>

      <div class="ui-section">
        <div class="ui-section-title">Render</div>
        <div class="ui-row checkbox-row">
          <input type="checkbox" id="show-ring">
          <label for="show-ring">Show ring</label>
        </div>
        <div class="ui-row checkbox-row">
          <input type="checkbox" id="show-metrics">
          <label for="show-metrics">Show metrics</label>
        </div>
        <div class="ui-row checkbox-row">
          <input type="checkbox" id="show-field-plot">
          <label for="show-field-plot">Field plot</label>
        </div>
        <div class="ui-row">
          <label>Point radius</label>
          <input type="number" id="input-point-radius" step="0.5" min="0.5">
        </div>
        <div class="ui-row checkbox-row">
          <input type="checkbox" id="scale-by-distance">
          <label for="scale-by-distance">Natural growth</label>
        </div>
        <button id="btn-update-field-plot" class="btn btn-small">Update Field Plot</button>
      </div>

      <div class="ui-section">
        <div class="ui-section-title">Import/Export</div>
        <div class="ui-row buttons">
          <button id="btn-export" class="btn btn-small">Export</button>
          <button id="btn-import" class="btn btn-small">Import</button>
        </div>
        <input type="file" id="import-file" accept=".json" style="display: none">
      </div>

      <div class="ui-section field-plot-section">
        <canvas id="field-plot-canvas"></canvas>
      </div>

      <div id="validation-messages"></div>
    `,this.runBtn=document.getElementById("btn-run"),this.pauseBtn=document.getElementById("btn-pause"),this.stepBtn=document.getElementById("btn-step"),this.resetBtn=document.getElementById("btn-reset"),this.applyBtn=document.getElementById("btn-apply"),this.presetSelect=document.getElementById("preset-select"),this.inputR=document.getElementById("input-R"),this.inputV=document.getElementById("input-v"),this.inputDt=document.getElementById("input-dt"),this.inputMaxR=document.getElementById("input-maxR"),this.inputAngleSamples=document.getElementById("input-angleSamples"),this.inputTotalPrimordia=document.getElementById("input-totalPrimordia"),this.inputBatchSize=document.getElementById("input-batchSize"),this.kernelTypeSelect=document.getElementById("kernel-type-select"),this.kernelParamsDiv=document.getElementById("kernel-params"),this.noiseEnabledCheckbox=document.getElementById("noise-enabled"),this.inputNoiseSigma=document.getElementById("input-noise-sigma"),this.inputNoiseSeed=document.getElementById("input-noise-seed"),this.showRingCheckbox=document.getElementById("show-ring"),this.showMetricsCheckbox=document.getElementById("show-metrics"),this.showFieldPlotCheckbox=document.getElementById("show-field-plot"),this.inputPointRadius=document.getElementById("input-point-radius"),this.scaleByDistanceCheckbox=document.getElementById("scale-by-distance"),this.updateFieldPlotBtn=document.getElementById("btn-update-field-plot"),this.fieldPlotCanvas=document.getElementById("field-plot-canvas"),this.fieldPlotCtx=this.fieldPlotCanvas.getContext("2d"),this.validationDiv=document.getElementById("validation-messages");for(let e=0;e<ae.length;e++){const i=document.createElement("option");i.value=String(e),i.textContent=ae[e].name,this.presetSelect.appendChild(i)}this.updateKernelParamsUI()}bindEvents(){this.runBtn.addEventListener("click",()=>this.callbacks.onRun()),this.pauseBtn.addEventListener("click",()=>this.callbacks.onPause()),this.stepBtn.addEventListener("click",()=>this.callbacks.onStep()),this.resetBtn.addEventListener("click",()=>this.callbacks.onReset()),this.applyBtn.addEventListener("click",()=>this.handleApply()),this.presetSelect.addEventListener("change",()=>this.handlePresetChange()),this.kernelTypeSelect.addEventListener("change",()=>this.updateKernelParamsUI()),this.updateFieldPlotBtn.addEventListener("click",()=>this.callbacks.onUpdateFieldPlot()),document.getElementById("btn-export").addEventListener("click",()=>this.handleExport()),document.getElementById("btn-import").addEventListener("click",()=>{document.getElementById("import-file").click()}),document.getElementById("import-file").addEventListener("change",e=>this.handleImport(e))}updateKernelParamsUI(){const e=this.kernelTypeSelect.value;let i="";switch(e){case"exp":i=`
          <div class="ui-row"><label>A</label><input type="number" id="kernel-A" step="0.1" value="1.0"></div>
          <div class="ui-row"><label>λ</label><input type="number" id="kernel-lambda" step="0.01" value="0.18"></div>
        `;break;case"gaussian":i=`
          <div class="ui-row"><label>A</label><input type="number" id="kernel-A" step="0.1" value="1.0"></div>
          <div class="ui-row"><label>σ</label><input type="number" id="kernel-sigma" step="0.01" value="0.15"></div>
        `;break;case"softPower":i=`
          <div class="ui-row"><label>A</label><input type="number" id="kernel-A" step="0.1" value="1.0"></div>
          <div class="ui-row"><label>p</label><input type="number" id="kernel-p" step="0.1" value="2.0"></div>
          <div class="ui-row"><label>ε</label><input type="number" id="kernel-eps" step="0.001" value="0.01"></div>
        `;break;case"hardCoreExp":i=`
          <div class="ui-row"><label>A</label><input type="number" id="kernel-A" step="0.1" value="1.0"></div>
          <div class="ui-row"><label>λ</label><input type="number" id="kernel-lambda" step="0.01" value="0.18"></div>
          <div class="ui-row"><label>d₀</label><input type="number" id="kernel-d0" step="0.01" value="0.05"></div>
        `;break;case"custom":i=`
          <div class="ui-row"><label>Expression f(d)</label></div>
          <textarea id="custom-expr" class="custom-expr-input" placeholder="e.g., A * exp(-d / lambda)"></textarea>
          <div id="custom-expr-validation" class="expr-validation"></div>
          <div class="ui-row"><label>A</label><input type="number" id="kernel-A" step="0.1" value="1.0"></div>
          <div class="ui-row"><label>λ</label><input type="number" id="kernel-lambda" step="0.01" value="0.18"></div>
          <div class="ui-row"><label>σ</label><input type="number" id="kernel-sigma" step="0.01" value="0.15"></div>
          <div class="ui-row"><label>p</label><input type="number" id="kernel-p" step="0.1" value="2.0"></div>
          <div class="ui-row"><label>ε</label><input type="number" id="kernel-eps" step="0.001" value="0.01"></div>
          <div class="ui-row"><label>d₀</label><input type="number" id="kernel-d0" step="0.01" value="0.05"></div>
          <div class="expr-help">Supported: +, -, *, /, ^, sqrt, exp, log, sin, cos, abs, min, max<br>Variables: d, A, lambda, sigma, p, eps, d0</div>
        `;break}this.kernelParamsDiv.innerHTML=i,this.inputKernelA=document.getElementById("kernel-A"),this.inputKernelLambda=document.getElementById("kernel-lambda"),this.inputKernelSigma=document.getElementById("kernel-sigma"),this.inputKernelP=document.getElementById("kernel-p"),this.inputKernelEps=document.getElementById("kernel-eps"),this.inputKernelD0=document.getElementById("kernel-d0"),this.customExprTextarea=document.getElementById("custom-expr"),this.customExprValidation=document.getElementById("custom-expr-validation"),this.customExprTextarea&&this.customExprTextarea.addEventListener("input",()=>this.validateCustomExpr()),this.currentConfig.kernel.type===e&&this.populateKernelParamsFromConfig(this.currentConfig.kernel)}validateCustomExpr(){if(!this.customExprTextarea||!this.customExprValidation)return;const e=this.customExprTextarea.value.trim();if(!e){this.customExprValidation.textContent="",this.customExprValidation.className="expr-validation";return}const i=_e(e);i?(this.customExprValidation.textContent=`Error: ${i}`,this.customExprValidation.className="expr-validation error"):(this.customExprValidation.textContent="Valid ✓",this.customExprValidation.className="expr-validation valid")}populateUIFromConfig(e){this.inputR.value=String(e.R),this.inputV.value=String(e.v),this.inputDt.value=String(e.dt),this.inputMaxR.value=String(e.maxR),this.inputAngleSamples.value=String(e.angleSamples),this.inputTotalPrimordia.value=String(e.totalPrimordia),this.inputBatchSize.value=String(e.batchSize),this.kernelTypeSelect.value=e.kernel.type,this.updateKernelParamsUI(),this.populateKernelParamsFromConfig(e.kernel),this.noiseEnabledCheckbox.checked=e.noise.enabled,this.inputNoiseSigma.value=String(e.noise.sigmaThetaDeg),this.inputNoiseSeed.value=String(e.noise.seed),this.showRingCheckbox.checked=e.render.showRing,this.showMetricsCheckbox.checked=e.render.showMetrics,this.showFieldPlotCheckbox.checked=e.render.showFieldPlot,this.inputPointRadius.value=String(e.render.pointRadius),this.scaleByDistanceCheckbox.checked=e.render.scaleByDistance}populateKernelParamsFromConfig(e){switch(e.type){case"exp":this.inputKernelA&&(this.inputKernelA.value=String(e.A)),this.inputKernelLambda&&(this.inputKernelLambda.value=String(e.lambda));break;case"gaussian":this.inputKernelA&&(this.inputKernelA.value=String(e.A)),this.inputKernelSigma&&(this.inputKernelSigma.value=String(e.sigma));break;case"softPower":this.inputKernelA&&(this.inputKernelA.value=String(e.A)),this.inputKernelP&&(this.inputKernelP.value=String(e.p)),this.inputKernelEps&&(this.inputKernelEps.value=String(e.eps));break;case"hardCoreExp":this.inputKernelA&&(this.inputKernelA.value=String(e.A)),this.inputKernelLambda&&(this.inputKernelLambda.value=String(e.lambda)),this.inputKernelD0&&(this.inputKernelD0.value=String(e.d0));break;case"custom":this.customExprTextarea&&(this.customExprTextarea.value=e.expr),this.inputKernelA&&(this.inputKernelA.value=String(e.params.A)),this.inputKernelLambda&&(this.inputKernelLambda.value=String(e.params.lambda)),this.inputKernelSigma&&(this.inputKernelSigma.value=String(e.params.sigma)),this.inputKernelP&&(this.inputKernelP.value=String(e.params.p)),this.inputKernelEps&&(this.inputKernelEps.value=String(e.params.eps)),this.inputKernelD0&&(this.inputKernelD0.value=String(e.params.d0)),this.validateCustomExpr();break}}readConfigFromUI(){var s;const e=this.kernelTypeSelect.value;let i;const n=(a,r)=>{if(!a)return r;const o=parseFloat(a.value);return isNaN(o)?r:o};switch(e){case"exp":i={type:"exp",A:n(this.inputKernelA,1),lambda:n(this.inputKernelLambda,.18)};break;case"gaussian":i={type:"gaussian",A:n(this.inputKernelA,1),sigma:n(this.inputKernelSigma,.15)};break;case"softPower":i={type:"softPower",A:n(this.inputKernelA,1),p:n(this.inputKernelP,2),eps:n(this.inputKernelEps,.01)};break;case"hardCoreExp":i={type:"hardCoreExp",A:n(this.inputKernelA,1),lambda:n(this.inputKernelLambda,.18),d0:n(this.inputKernelD0,.05)};break;case"custom":i={type:"custom",expr:((s=this.customExprTextarea)==null?void 0:s.value)||"A * exp(-d / lambda)",params:{A:n(this.inputKernelA,1),lambda:n(this.inputKernelLambda,.18),sigma:n(this.inputKernelSigma,.15),p:n(this.inputKernelP,2),eps:n(this.inputKernelEps,.01),d0:n(this.inputKernelD0,.05)}};break}return{R:n(this.inputR,1),v:n(this.inputV,.02),dt:n(this.inputDt,1),maxR:n(this.inputMaxR,3),angleSamples:Math.floor(n(this.inputAngleSamples,720)),totalPrimordia:Math.floor(n(this.inputTotalPrimordia,600)),batchSize:Math.floor(n(this.inputBatchSize,30)),kernel:i,noise:{enabled:this.noiseEnabledCheckbox.checked,sigmaThetaDeg:n(this.inputNoiseSigma,2),seed:Math.floor(n(this.inputNoiseSeed,12345))},render:{showRing:this.showRingCheckbox.checked,showMetrics:this.showMetricsCheckbox.checked,showFieldPlot:this.showFieldPlotCheckbox.checked,pointRadius:n(this.inputPointRadius,5),scaleByDistance:this.scaleByDistanceCheckbox.checked}}}handleApply(){const e=this.readConfigFromUI(),i=de(e);this.showValidation(i),!(!i.valid||ae.find(s=>s.isStressTest&&e.totalPrimordia>=1e4)&&!confirm("This configuration may cause performance issues. Continue?"))&&(this.currentConfig=e,window.location.hash=Gt(e),this.callbacks.onApply(te(e)))}handlePresetChange(){const e=parseInt(this.presetSelect.value),i=ae[e];i&&(this.currentConfig=te(i.config),this.populateUIFromConfig(this.currentConfig))}handleExport(){const e=this.readConfigFromUI(),i=JSON.stringify(e,null,2),n=new Blob([i],{type:"application/json"}),s=URL.createObjectURL(n),a=document.createElement("a");a.href=s,a.download="phyllotaxis-config.json",a.click(),URL.revokeObjectURL(s)}handleImport(e){var a;const i=e.target,n=(a=i.files)==null?void 0:a[0];if(!n)return;const s=new FileReader;s.onload=()=>{try{const r=JSON.parse(s.result),o=de(r);this.showValidation(o),o.valid&&(this.currentConfig=r,this.populateUIFromConfig(r),this.callbacks.onApply(te(r)))}catch(r){this.showValidation({valid:!1,errors:[`Invalid JSON: ${r}`],warnings:[]})}},s.readAsText(n),i.value=""}showValidation(e){let i="";for(const n of e.errors)i+=`<div class="validation-error">${n}</div>`;for(const n of e.warnings)i+=`<div class="validation-warning">${n}</div>`;this.validationDiv.innerHTML=i}setRunning(e){this.runBtn.disabled=e,this.pauseBtn.disabled=!e}getConfig(){return te(this.currentConfig)}}function Ke(t,e){const i=window.devicePixelRatio||1,n=t.getBoundingClientRect();t.width=n.width*i,t.height=n.height*i,e.setTransform(i,0,0,i,0,0)}function je(t){const e=window.devicePixelRatio||1;return{width:t.width/e,height:t.height/e}}function Jt(t,e,i,n){const{width:s,height:a}=je(t);if(e.clearRect(0,0,s,a),i.length===0)return;let r=n.R;for(const u of i)u.r>r&&(r=u.r);const o=Math.min(s,a)*.45/r,l=s/2,p=a/2,c=n.render.pointRadius,d=n.render.scaleByDistance;for(let u=0;u<i.length;u++){const f=i[u],b=l+f.r*f.ct*o,x=p+f.r*f.st*o,P=u*360/n.totalPrimordia;let k=c;if(d){const E=f.r/r;k=c*(.2+.8*E)}e.beginPath(),e.arc(b,x,k,0,2*Math.PI),e.fillStyle=`hsl(${P}, 70%, 50%)`,e.fill()}n.render.showRing&&(e.beginPath(),e.arc(l,p,n.R*o,0,2*Math.PI),e.strokeStyle="rgba(201, 162, 39, 0.5)",e.lineWidth=1,e.stroke())}function Wt(t,e,i,n,s){t.font="12px monospace",t.fillStyle="rgba(31, 42, 34, 0.85)";const a=[`Primordia: ${n} / ${s}`,`Divergence (last ${i.count}): ${i.mean.toFixed(2)}° ± ${i.stdDev.toFixed(2)}°`];let r=20;for(const o of a)t.fillText(o,10,r),r+=16}function Qt(t,e,i){const n=window.devicePixelRatio||1,s=t.getBoundingClientRect();t.width=s.width*n,t.height=s.height*n,e.setTransform(n,0,0,n,0,0);const a=s.width,r=s.height;if(e.fillStyle="#F3E6C9",e.fillRect(0,0,a,r),i.length===0)return;const o=1e20;let l=1/0,p=-1/0;for(let b=0;b<i.length;b++){const x=i[b];x<o&&(x<l&&(l=x),x>p&&(p=x))}if(!isFinite(l)||!isFinite(p)||l===p){e.fillStyle="rgba(31, 42, 34, 0.4)",e.fillText("No field data",10,r/2);return}const c=p-l,d=4,u=r-2*d,f=a-2*d;e.beginPath(),e.strokeStyle="#375D42",e.lineWidth=1.5;for(let b=0;b<i.length;b++){const x=d+b/(i.length-1)*f;let P=i[b];P>=o&&(P=p);const k=d+u-(P-l)/c*u;b===0?e.moveTo(x,k):e.lineTo(x,k)}e.stroke(),e.font="9px monospace",e.fillStyle="rgba(31, 42, 34, 0.6)",e.fillText(`min: ${l.toFixed(2)}`,d,r-2),e.fillText(`max: ${p.toFixed(2)}`,a-60,r-2)}let w,C,z,ie,q=!1,U=null,B,K=!0;const Zt=10;let ne=0;function J(){if(Jt(z,ie,w.primordia,B),B.render.showMetrics){const t=w.computeDivergenceMetrics(),{width:e}=je(z);Wt(ie,e,t,w.primordia.length,B.totalPrimordia)}}function ee(){if(B.render.showFieldPlot&&K){const t=w.getFieldValues();Qt(C.fieldPlotCanvas,C.fieldPlotCtx,t),K=!1}}function He(){if(!q||w.isComplete()){if(w.isComplete()){q=!1,C.setRunning(!1),console.log("Simulation complete");const t=w.computeDivergenceMetrics();console.log(`Divergence angle (last ${t.count}): mean=${t.mean.toFixed(2)}°, stdDev=${t.stdDev.toFixed(2)}°`)}U=null;return}w.runBatch(),B.render.showFieldPlot&&(ne++,ne>=Zt&&(ne=0,K=!0,ee())),J(),U=requestAnimationFrame(He)}function ei(t){B=t,w.init(t),w.reset(),q=!1,C.setRunning(!1),K=!0,ne=0,ee(),J()}function ti(){w.isComplete()||(q=!0,C.setRunning(!0),U===null&&(U=requestAnimationFrame(He)))}function ii(){q=!1,C.setRunning(!1)}function ni(){w.isComplete()||(q=!1,C.setRunning(!1),w.step(),K=!0,ee(),J())}function si(){q=!1,C.setRunning(!1),U!==null&&(cancelAnimationFrame(U),U=null),w.reset(),K=!0,ne=0,ee(),J()}function ri(){K=!0,ee()}function Ne(){z=document.getElementById("canvas");const t=z.getContext("2d");if(!t){console.error("Failed to get 2D context");return}ie=t,Ke(z,ie),w=new zt,C=new Xt({onApply:ei,onRun:ti,onPause:ii,onStep:ni,onReset:si,onUpdateFieldPlot:ri}),B=C.init(),w.init(B),w.reset(),K=!0,ee(),J(),window.addEventListener("resize",()=>{Ke(z,ie),J()}),C.setRunning(!1)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ne):Ne();
